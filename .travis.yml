language: cpp

env:
  matrix:
  - NODE_NVM_VERSION="0.10.33"
  global:
  - secure: Tvi/L+RQV8KXprOAHtOOVmeh6BIr4xkLRA7Fus5BJbzXT+LfUhYU2cbCaFSzc5i9Svz5OpYe4VtlgrAn1dG/Sj3SOQL/DzfZJjoYpU+DRdO3v54naT97JUYCmKSB+8ZR4XxEP7MTRShDAh/rmq1+W9rBaMuYCcippMkAXbk1UFg=

before_install:
- export platform=$(uname -s | sed "y/ABCDEFGHIJKLMNOPQRSTUVWXYZ/abcdefghijklmnopqrstuvwxyz/")
- if [[ "$platform" == "linux" ]]; then sudo add-apt-repository --yes ppa:ubuntu-toolchain-r/test; sudo apt-get update; sudo apt-get install gcc-4.8 g++-4.8; export CXX=g++-4.8; fi
- git clone https://github.com/creationix/nvm.git ../.nvm
- source ../.nvm/nvm.sh
- nvm install $NODE_NVM_VERSION
- nvm use $NODE_NVM_VERSION
- node --version
- npm --version
- sudo ./test/travis-protobuf.sh

install:
#- npm install --build-from-source
 - echo "running scan-build"
# not needed: coverity runs it

script:
- npm test

addons:
  coverity_scan:
    project:
      name: "mapbox/carmen-cache"
      description: "Protobuf-based cache"
    notification_email: dane@mapbox.com
    build_command:   "npm install --build-from-source"
    branch_pattern: coverity_scan